CC	= @CC@
CXX	= @CXX@
JAR	= @JAR@
LEX	= @LEX@
RANLIB	= @RANLIB@
YACC	= @YACC@

CPPFLAGS	= @CPPFLAGS@ -Iinclude/breve @JAVAINCS@ @DEFS@
LDFLAGS		= @LDFLAGS@

EXTRACFLAGS	= -g

CFLAGS		= $(EXTRACFLAGS) -pipe -Wall
CXXFLAGS	= $(EXTRACFLAGS) -pipe -Wall -fpermissive
YFLAGS		= -d

PLATFORM	= @PLATFORM@
LPLATFORM	= $(shell echo $(PLATFORM) | tr '[A-Z]' '[a-z]')

DMG_FILE	= breve_@VERSION@.dmg
CLI_FOLDER	= breve_@VERSION@

all: bin/breve@EXE_SUFFIX@ bin/breve_cli@EXE_SUFFIX@ bin/graphTest@EXE_SUFFIX@ \
	lib/classes/MethodFinder.jar

include simulation/Makefile
include kernel/Makefile
include graph/Makefile
include neural/Makefile
include steve/Makefile
include java/Makefile
include docBuild/Makefile
include util/Makefile
include .depend

DEPS	:= $(SRC) bin/breve.cc bin/breve_cli.cc graph/graphTest.cc
OBJ	:= $(SRC:.cc=.o)
OBJ	:= $(OBJ:.c=.o)

bin/breve@EXE_SUFFIX@: bin/breve.o $(OBJ)
	$(CXX) -o $@ $(LDFLAGS) $^ @LIBS@ @GLLIBS@ @AUDIOLIBS@

bin/breve_cli@EXE_SUFFIX@: bin/breve_cli.o $(OBJ)
	$(CXX) -o $@ $(LDFLAGS) $^ @LIBS@ @GLLIBS@ @AUDIOLIBS@

bin/graphTest@EXE_SUFFIX@: graph/graphTest.o $(OBJ)
	$(CXX) -o $@ $(LDFLAGS) $^ @LIBS@ @GLLIBS@ @AUDIOLIBS@

%.o: %.c
	$(CC) $(CFLAGS) -c -o $@ $< $(CPPFLAGS) 

%.o: %.cc
	$(CXX) $(CXXFLAGS) -c -o $@ $< $(CPPFLAGS) 

%.tab.c: %.y
	$(YACC) $(YFLAGS) -o $@ $<

%.class: %.java
	-@JAVAC@ $<

optimize:
	$(MAKE) EXTRACFLAGS='-O3'

optimize_debug:
	$(MAKE) EXTRACFLAGS='-g -O3'

profile:
	$(MAKE) EXTRACFLAGS='-pg -O3'

.depend: $(DEPS)
	@for i in $(DEPS); do echo -n `dirname $$i`/ >> .depend; \
		@MKDEP@ $(CPPFLAGS) $$i >> .depend; done

.PHONY: clean OSX_build OSX_clean OSX_release CLI_release plugin_API install

clean:
	rm -f bin/breve bin/breve_cli bin/graphTest
	rm -f steve/format.c steve/stevelex.c
	rm -f steve/steveparse.tab.c steve/steveparse.tab.h
	rm -f java/*.class lib/classes/*.jar
	rm -rf docBuild/docs docs
	rm -rf OSX/build
	echo -n > .depend
	find . -name '.DS_Store' -exec rm -f {} \;
	find . -name 'core' -exec rm -f {} \;
	find . -name '.gdb*' -exec rm -f {} \;
	find . -name '*.core' -exec rm -f {} \;
	find . -name '*.o' -exec rm -f {} \;

lib/libbreve.a: $(OBJ)
	$(AR) -crv lib/libbreve.a $(OBJ)
	ranlib lib/libbreve.a

OSX_build: optimize lib/libbreve.a
	-mkdir docs
	cd plugins; $(MAKE)
	cd OSX; xcodebuild -buildstyle Deployment CC= LIBS='@LDFLAGS@ @LIBS@'

OSX_clean: clean
	rm -f $(DMG_FILE)
	cd plugins; $(MAKE) clean
	cd OSX; xcodebuild clean
	rm -rf OSX/build plugins/*/build

OSX_release: OSX_clean
	$(MAKE) documentation
	$(MAKE) OSX_build
	rm -f $(DMG_FILE)
	rm -rf breve_image_folder
	mkdir breve_image_folder
	cp -R OSX/build/breve.app breve_image_folder
	cp OSX/README.html breve_image_folder
	cp OSX/Documentation.txt breve_image_folder
	cp Changes.html breve_image_folder
	mkdir breve_image_folder/plugins
	cp -R plugins/samples plugins/slBrevePluginAPI.h plugins/README.txt breve_image_folder/plugins
	make_dmg.sh $(DMG_FILE) breve_image_folder/*
	rm -rf breve_image_folder

CLI_release: clean
	$(MAKE) documentation
	$(MAKE) optimize
	rm -rf $(CLI_FOLDER)
	mkdir $(CLI_FOLDER)
	mkdir $(CLI_FOLDER)/bin
	mkdir $(CLI_FOLDER)/lib
	cp bin/breve@EXE_SUFFIX@ $(CLI_FOLDER)/bin/
	cp bin/breve_cli@EXE_SUFFIX@ $(CLI_FOLDER)/bin/
	cp -R lib/classes $(CLI_FOLDER)/lib/
	cp -R docs $(CLI_FOLDER)/
	cp -R demos $(CLI_FOLDER)/
	mkdir $(CLI_FOLDER)/plugins
	cp -R plugins/samples plugins/slBrevePluginAPI.h plugins/README.txt $(CLI_FOLDER)/plugins
	rm -rf $(CLI_FOLDER)/demos/Music
	cp README.txt $(CLI_FOLDER)/
	cp Changes.html $(CLI_FOLDER)/
	find $(CLI_FOLDER) -name CVS -prune -exec rm -rf {} \;
	rm -f breve_$(LPLATFORM)_@VERSION@.@ARCHIVE_SUFFIX@
	@ARCHIVER@ breve_$(LPLATFORM)_@VERSION@.@ARCHIVE_SUFFIX@ $(CLI_FOLDER)

plugin_API:
	rm -rf breve_plugin_API
	mkdir breve_plugin_API
	cp plugins/slBrevePluginAPI.h breve_plugin_API
	cp plugins/README.html breve_plugin_API
	@ARCHIVER@ breve_plugin_API.@ARCHIVE_SUFFIX@ breve_plugin_API
	rm -rf breve_plugin_API

install: optimize
	mkdir -p @bindir@
	mkdir -p @libdir@/breve
	cp bin/breve @bindir@
	cp bin/breve_cli @bindir@
	rm -rf @libdir@/breve/classes
	mkdir @libdir@/breve
	cp -R lib/classes @libdir@/breve
