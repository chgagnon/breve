CC	= @CC@
CXX	= @CXX@
DLLTOOL = @DLLTOOL@
JAR	= @JAR@
LEX	= @LEX@
RANLIB	= @RANLIB@
YACC	= @YACC@

@SET_MAKE@

CPPFLAGS	= @CPPFLAGS@ -Iinclude/breve @DEFS@
LDFLAGS		= @LDFLAGS@

EXTRACFLAGS	= -g

CXXFLAGS	= $(EXTRACFLAGS) -pipe -Wall -fpermissive
YFLAGS		= -d

PLATFORM	= @PLATFORM@
LPLATFORM	= $(shell echo $(PLATFORM)|tr '[A-Z]' '[a-z]'|tr -d '[0-9].-')

DMG_FILE	= breve_@VERSION@.dmg
CLI_FOLDER	= breve_@VERSION@

exec_prefix	= @exec_prefix@
prefix		= @prefix@

all: .depend bin/breve@EXE_SUFFIX@ bin/breve_cli@EXE_SUFFIX@ \
	lib/classes/MethodFinder.jar

include simulation/Makefile
include kernel/Makefile
include graph/Makefile
include neural/Makefile
include steve/Makefile
include java/Makefile
include docBuild/Makefile
include util/Makefile
-include .depend

DEPS	:= $(SRC) bin/breve.cc bin/breve_cli.cc 
OBJ	:= $(SRC:.cc=.o)
OBJ	:= $(OBJ:.c=.o)

bin/breve@EXE_SUFFIX@: bin/breve.o $(OBJ)
	$(CXX) -o $@ $(LDFLAGS) $^ @PLUGINIMP@ @LIBS@

bin/breve_cli@EXE_SUFFIX@: bin/breve_cli.o $(OBJ)
	$(CXX) -o $@ $(LDFLAGS) $^ @PLUGINIMP@ @LIBS@

breve.dll: $(OBJ)
	$(CXX) @PLUGINFLAGS@ -o $@ @PLUGINIMP@ $^ @LIBS@

%.o: %.c
	$(CXX) $(CXXFLAGS) -c -o $@ $< $(CPPFLAGS) 

%.o: %.cc
	$(CXX) $(CXXFLAGS) -c -o $@ $< $(CPPFLAGS) 

%.tab.c: %.y
	$(YACC) $(YFLAGS) -o $@ $<

%.class: %.java
	@JAVAC@ $<

debug: all

optimize:
	$(MAKE) EXTRACFLAGS='-O4 -mdynamic-no-pic -falign-loops=16'

optimize_debug:
	$(MAKE) EXTRACFLAGS='-g -O3'

profile:
	$(MAKE) EXTRACFLAGS='-pg -O3'

lib/libbreve.a: $(OBJ)
	$(AR) -cr $@ $(OBJ)
	$(RANLIB) $@

.depend:: $(DEPS)
	@echo -n "Generating dependencies... "
	@for i in $(DEPS); do echo -n `dirname $$i`/ >> .depend; \
		@MKDEP@ $(CPPFLAGS) $$i >> .depend; done
	@echo "done."

# this rule is a no-op to avoid updating .depend needlessly
# it must have commands and no prerequisites and must not touch .depend
.depend::
	@echo -n

.PHONY: clean OSX_build OSX_clean OSX_release CLI_release plugin_API install

clean:
	rm -f bin/breve@EXE_SUFFIX@ bin/breve_cli@EXE_SUFFIX@
	rm -f .depend 
	rm -f steve/format.c steve/stevelex.c
	rm -f steve/steveparse.tab.c steve/steveparse.tab.h
	rm -f java/*.class lib/classes/*.jar
	rm -f breve.dll breve.def lib/*.a lib/plugin.def
	rm -rf docs docBuild/docs OSX/build
	find . -name '.DS_Store' -exec rm -f {} \;
	find . -name 'core' -exec rm -f {} \;
	find . -name '.gdb*' -exec rm -f {} \;
	find . -name '*.core' -exec rm -f {} \;
	find . -name '*.o' -exec rm -f {} \;

OSX_build: optimize lib/libbreve.a
	-mkdir docs
	cd plugins; $(MAKE)
	cd OSX; xcodebuild -buildstyle Deployment CC= LIBS='@LDFLAGS@ @LIBS@'

OSX_clean: clean
	rm -f $(DMG_FILE)
	cd plugins; $(MAKE) clean
	cd OSX; xcodebuild clean
	rm -rf OSX/build plugins/*/build

OSX_release: OSX_clean
	$(MAKE) documentation
	$(MAKE) OSX_build
	rm -f $(DMG_FILE)
	rm -rf breve_image_folder
	mkdir breve_image_folder
	cp -R OSX/build/breve.app breve_image_folder
	cp OSX/README.html breve_image_folder
	cp OSX/Documentation.txt breve_image_folder
	cp Changes.html breve_image_folder
	mkdir breve_image_folder/plugins
	cp -R plugins/samples plugins/slBrevePluginAPI.h plugins/README.txt breve_image_folder/plugins
	make_dmg.sh $(DMG_FILE) breve_image_folder/*
	rm -rf breve_image_folder

CLI_release: clean
	# $(MAKE) documentation
	-mkdir docs
	$(MAKE) optimize
	rm -rf $(CLI_FOLDER)
	mkdir $(CLI_FOLDER)
	mkdir $(CLI_FOLDER)/bin
	mkdir $(CLI_FOLDER)/lib
	cp bin/breve@EXE_SUFFIX@ $(CLI_FOLDER)/bin/
	cp bin/breve_cli@EXE_SUFFIX@ $(CLI_FOLDER)/bin/
	cp -R lib/classes $(CLI_FOLDER)/lib/
	cp -R docs $(CLI_FOLDER)/
	cp -R demos $(CLI_FOLDER)/
	mkdir $(CLI_FOLDER)/plugins
	cp -R plugins/samples plugins/slBrevePluginAPI.h plugins/README.txt $(CLI_FOLDER)/plugins
	rm -rf $(CLI_FOLDER)/demos/Music
	cp README.txt $(CLI_FOLDER)/
	cp Changes.html $(CLI_FOLDER)/
	find $(CLI_FOLDER) -name CVS -prune -exec rm -rf {} \;
	find $(CLI_FOLDER) -name '.cvsignore' -prune -exec rm -rf {} \;
	rm -f breve_$(LPLATFORM)_@VERSION@.@ARCHIVE_SUFFIX@
	@ARCHIVER@ breve_$(LPLATFORM)_@VERSION@.@ARCHIVE_SUFFIX@ $(CLI_FOLDER)

plugin_API:
	rm -rf breve_plugin_API
	mkdir breve_plugin_API
	cp plugins/slBrevePluginAPI.h breve_plugin_API
	cp plugins/README.html breve_plugin_API
	@ARCHIVER@ breve_plugin_API.@ARCHIVE_SUFFIX@ breve_plugin_API
	rm -rf breve_plugin_API

install: optimize
	mkdir -p @bindir@
	cp bin/breve @bindir@
	cp bin/breve_cli @bindir@
	mkdir -p @libdir@/breve
	rm -rf @libdir@/breve/classes
	cp -R lib/classes @libdir@/breve
